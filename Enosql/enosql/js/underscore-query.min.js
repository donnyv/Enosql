(function(e){var r,t,n,a,u,s,c,i,l,o,$,f,y,h,p,g={}.hasOwnProperty,d=[].indexOf||function(e){for(var r=0,t=this.length;t>r;r++)if(r in this&&this[r]===e)return r;return-1};for(f=e("underscore"),$={},p=["every","some","filter","reject","reduce","intersection","isEqual","keys","isArray","result"],y=0,h=p.length;h>y;y++)n=p[y],$[n]=f[n];$.getType=function(e){var r;return r=Object.prototype.toString.call(e).substr(8),r.substr(0,r.length-1)},$.makeObj=function(e,r){var t;return(t={})[e]=r,t},$.getNested=function(e){return function(r){var t,a,u;for(t=r,a=0,u=e.length;u>a;a++)n=e[a],t&&(t=t[n]);return t}},$.reverseString=function(e){return e.toLowerCase().split("").reverse().join("")},$.compoundKeys=["$and","$not","$or","$nor"],$.seperator=".",s=function(e){var r,t,a,c,i,l,f,y,h,p,v;for(c=$.isArray(e)?e:function(){var r;r=[];for(n in e)g.call(e,n)&&(f=e[n],r.push($.makeObj(n,f)));return r}(),v=[],h=0,p=c.length;p>h;h++){a=c[h];for(n in a)if(g.call(a,n)){switch(i=a[n],r={key:n},-1!==n.indexOf($.seperator)&&(r.getter=$.getNested(n.split($.seperator))),t=$.getType(i)){case"RegExp":case"Date":r.type="$"+t.toLowerCase(),r.value=i;break;case"Object":if(d.call($.compoundKeys,n)>=0)r.type=n,r.value=s(i),r.key=null;else for(l in i){if(y=i[l],!o(l,y))throw Error("Query value doesn't match query type: "+l+": "+y);switch(r.type=l,l){case"$elemMatch":r.value=u(y);break;case"$endsWith":r.value=$.reverseString(y);break;case"$likeI":case"$startsWith":r.value=y.toLowerCase();break;default:r.value=y}}break;default:r.type="$equal",r.value=i}"$equal"!==r.type||"Object"!==t&&"Array"!==t||(r.type="$deepEqual")}v.push(r)}return v},o=function(e,r){var t;switch(t=$.getType(r),e){case"$in":case"$nin":case"$all":case"$any":return"Array"===t;case"$size":return"Number"===t;case"$regex":case"$regexp":return"RegExp"===t;case"$like":case"$likeI":return"String"===t;case"$between":case"$mod":return"Array"===t&&2===r.length;case"$cb":return"Function"===t;default:return!0}},l=function(e,r){var t;switch(t=$.getType(r),e){case"$like":case"$likeI":case"$regex":case"$startsWith":case"$endsWith":return"String"===t;case"$contains":case"$all":case"$any":case"$elemMatch":return"Array"===t;case"$size":return"String"===t||"Array"===t;case"$in":case"$nin":return null!=r;default:return!0}},c=function(e,r,n,a){switch(e){case"$equal":return $.isArray(n)?d.call(n,r)>=0:n===r;case"$deepEqual":return $.isEqual(n,r);case"$contains":return d.call(n,r)>=0;case"$ne":return n!==r;case"$lt":return r>n;case"$gt":return n>r;case"$lte":return r>=n;case"$gte":return n>=r;case"$between":return n>r[0]&&r[1]>n;case"$betweene":return n>=r[0]&&r[1]>=n;case"$in":return d.call(r,n)>=0;case"$nin":return 0>d.call(r,n);case"$all":return $.every(r,function(e){return d.call(n,e)>=0});case"$any":return $.some(n,function(e){return d.call(r,e)>=0});case"$size":return n.length===r;case"$exists":case"$has":return null!=n===r;case"$like":return-1!==n.indexOf(r);case"$likeI":return-1!==n.toLowerCase().indexOf(r);case"$startsWith":return 0===n.toLowerCase().indexOf(r);case"$endsWith":return 0===$.reverseString(n).indexOf(r);case"$type":return typeof n===r;case"$regex":case"$regexp":return r.test(n);case"$cb":return r.call(a,n);case"$mod":return n%r[0]===r[1];case"$elemMatch":return i(n,r,null,!0).length>0;case"$and":case"$or":case"$nor":case"$not":return 1===t([a],r,e).length;default:return!1}},t=function(e,r,t,n){var a,u;return u="$and"===t||"$or"===t?$.filter:$.reject,a="$or"===t||"$nor"===t,u(e,function(e){var t,u,s,i,o;for(i=0,o=r.length;o>i;i++)if(u=r[i],t=u.getter?u.getter(e):n?n(e,u.key):e[u.key],s=l(u.type,t),s&&(s=c(u.type,u.value,t,e)),a===s)return a;return!a})},u=function(e){var r,t,a,u;if(t=$.keys(e),r=$.intersection($.compoundKeys,t),0===r.length)return[{type:"$and",parsedQuery:s(e)}];if(r.length!==t.length){0>d.call(r,"$and")&&(e.$and={},r.unshift("$and"));for(n in e)g.call(e,n)&&(u=e[n],0>d.call($.compoundKeys,n)&&(e.$and[n]=u,delete e[n]))}return function(){var t,n,u;for(u=[],t=0,n=r.length;n>t;t++)a=r[t],u.push({type:a,parsedQuery:s(e[a])});return u}()},r=function(e,r,t){var a,u,s,c,l;for(a={items:e,getter:r,isParsed:t,theQuery:{}},a.all=a.find=a.query=a.run=function(e,r,t){return null==e&&(e=a.items),null==r&&(r=a.getter),null==t&&(t=a.isParsed),i(e,a.theQuery,r,t)},a.first=function(){var e;return null!=(e=a.all.apply(this,arguments))?e[0]:void 0},a.chain=function(){return f.chain(a.all.apply(this,arguments))},l=$.compoundKeys,u=function(e){var r;return r=e.substr(1),a[r]=function(r,t){var n,u;return t&&(r=$.makeObj(r,t)),null==(u=(n=a.theQuery)[e])&&(n[e]=[]),a.theQuery[e].push(r),a}},s=0,c=l.length;c>s;s++)n=l[s],u(n);return a},a=function(e,r){var t;return t=u(e),function(e){return $.isArray(e)||(e=[e]),i(e,t,r,!0).length===e.length}},i=function(e,n,a,s){var c,i;return 2>arguments.length?r.apply(this,arguments):(s||(n=u(n)),"String"===$.getType(a)&&(c=a,a=function(e,r){return e[c](r)}),i=function(e,r){return t(e,r.parsedQuery,r.type,a)},$.reduce(n,i,e))},i.build=r,i.parse=u,i.tester=a,f.mixin({query:i})}).call(this,"undefined"!=typeof exports?require:function(e){return this["underscore"===e?"_":e]});